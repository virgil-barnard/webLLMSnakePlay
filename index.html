<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Snake with LLM Cheerleader</title>
  <style>
    body,html{font-family:Arial,Helvetica,sans-serif;margin:0;padding:12px 20px;box-sizing:border-box;}
    .download-container{display:flex;gap:8px;margin-bottom:14px;}
    select,button{font-size:14px;}
    .chat-box{height:160px;max-width:760px;border:2px solid #000;background:#f7f7f7;padding:6px;overflow-y:auto;white-space:pre-wrap;margin:12px 0;}
    .msg{padding:6px 8px;border-radius:8px;margin:4px 0;max-width:75%;word-break:break-word;}
    .assistant{background:#f1f0f0;color:#333;}
    #game{background:#111;border:2px solid #000;display:block;margin:auto;}
  </style>
</head>
<body>
  <div class="download-container">
    <select id="model"></select>
    <button id="dl">Download model</button>
    <span id="status"></span>
  </div>

  <canvas id="game" width="400" height="400"></canvas>
  <div id="info">Length: 1 | High score: 1</div>
  <div id="chat" class="chat-box"></div>

<script type="module">
import * as webllm from "https://esm.run/@mlc-ai/web-llm";

/* â”€â”€ MODEL LOADING â”€â”€ */
const modelSel=document.getElementById("model");
webllm.prebuiltAppConfig.model_list.forEach(m=>{const o=document.createElement("option");o.value=m.model_id;o.textContent=m.model_id;modelSel.appendChild(o);});
const engine=new webllm.MLCEngine();engine.setInitProgressCallback(r=>document.getElementById("status").textContent=r.text);
async function loadModel(){await engine.reload(modelSel.value,{temperature:0.5});console.log("model loaded");}

/* â”€â”€ GAME â”€â”€ */
const CELL=20,GRID=20,ctx=document.getElementById("game").getContext("2d");
const DIRS={ArrowUp:"U",ArrowDown:"D",ArrowLeft:"L",ArrowRight:"R"};
const VEC={U:[0,-1],D:[0,1],L:[-1,0],R:[1,0]};
const savedHigh=Number(localStorage.getItem("snake_highscore"))||1;
let snake=[],dir="R",food={x:0,y:0},over=false,len=1,high=savedHigh,loopId=null;
function placeFood(){do{food={x:Math.random()*GRID|0,y:Math.random()*GRID|0};}while(snake.some(b=>b.x===food.x&&b.y===food.y));}
function updateInfo(){document.getElementById("info").textContent=`Length: ${len} | High score: ${high}`;}
function draw(){ctx.fillStyle="#111";ctx.fillRect(0,0,400,400);ctx.fillStyle="#e11d48";ctx.fillRect(food.x*CELL,food.y*CELL,CELL,CELL);ctx.fillStyle="#22c55e";snake.forEach(b=>ctx.fillRect(b.x*CELL,b.y*CELL,CELL,CELL));}
function reset(){snake=[{x:10,y:10}];dir="R";over=false;len=1;placeFood();updateInfo();draw();if(loopId)clearInterval(loopId);loopId=setInterval(step,200);}
function step(){if(over||!snake.length)return;const [dx,dy]=VEC[dir];const head={x:(snake[0].x+dx+GRID)%GRID,y:(snake[0].y+dy+GRID)%GRID};
  if(snake.some(b=>b.x===head.x&&b.y===head.y)){over=true;pushMsg("assistant","Oops! You crashed ðŸ˜¢. Refresh to try again.");clearInterval(loopId);return;}
  snake.unshift(head);
  if(head.x===food.x&&head.y===food.y){len++;if(len>high){high=len;localStorage.setItem("snake_highscore",String(high));pushPraise(true);}else pushPraise(false);placeFood();}
  else snake.pop();
  draw();updateInfo();}

/* â”€â”€ USER CONTROL â”€â”€ */
window.addEventListener("keydown",e=>{if(DIRS[e.key]){const nd=DIRS[e.key];const opp={U:"D",D:"U",L:"R",R:"L"};if(nd!==opp[dir])dir=nd;}});

/* â”€â”€ CHAT UI â”€â”€ */
const chat=document.getElementById("chat");
function pushMsg(role,text){const d=document.createElement("div");d.className=`msg ${role}`;d.textContent=text;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;}

/* â”€â”€ LLM FEEDBACK â”€â”€ */
const SYS="You are a supportive, enthusiastic Snake-game coach. Keep messages under 20 words.";
async function pushPraise(newRecord){const diff=high-len;const prompt={role:"user",content:JSON.stringify({length:len,high:high,diff,newRecord})};try{const rep=await engine.chat.completions.create({messages:[{role:"system",content:SYS},prompt]});pushMsg("assistant",rep.choices[0].message.content.trim());}catch(e){console.log(e);} }

/* â”€â”€ BUTTONS â”€â”€ */
document.getElementById("dl").onclick=async()=>{await loadModel();reset();};
</script>
</body>
</html>